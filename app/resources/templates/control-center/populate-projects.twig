<div class="modal fade" id="populateProjectsModal" tabindex="-1" aria-labelledby="populateProjectsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="populateProjectsModalLabel">Populate Document(s)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="populateProjectsAccordion" class="accordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse">
                    Processing...
                    </button>
                </h2>
                <div class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                    <div class="accordion-body">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processng...</span>
                    </div>
                    </div>
                </div>
            </div>          
          </div>
        </div>
      </div>
    </div>
 </div>

  <!-- Accordion Item Template -->
  <template id="populateProjectTemplate">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse">
          Processing...
        </button>
      </h2>
      <div class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
        <div class="accordion-body">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Processng...</span>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script type="text/javascript">
    function populateProjects() {
      const baseUrl = "{{ paths.populate_project|raw }}";
      const projects = loadProjects();
      
      const accordion = $('#populateProjectsAccordion');
      accordion.empty();

      const modal = new bootstrap.Modal(document.getElementById('populateProjectsModal'));
      modal.show();

      projects.forEach((project, index) => {
        const template = document.getElementById('populateProjectTemplate');
        const clone = template.content.cloneNode(true);
        const panelId = `populateProjectPanel_${project.project_id}`;
        const collapseId = `populateProjecetCollapse_${project.project_id}`;
        const url = baseUrl + "&project_id=" + project.project_id;

        if (project.enabled == false) return;

        $(clone).find('.accordion-header').attr('id', panelId);
        $(clone).find('.accordion-button')
          .attr('data-bs-target', `#${collapseId}`)
          .attr('aria-controls', collapseId);
        $(clone).find('.accordion-collapse')
          .attr('id', collapseId);

        $('#populateProjectsAccordion').append(clone);

        $.ajax({
          url: url,
          method: "GET",
          dataType: "json",
          success: function(data) {
            const message = data.message || "No message";
            const log = data.log || "";
            const logContent = log.length > 0
              ? `<pre>${log}</pre>`
              : '<em>No log entries</em>';

            $(`#${panelId} button`).text(message);
            $(`#${collapseId} .accordion-body`).html(logContent);
          },
          error: function(xhr) {
            $(`#${panelId} button`).text(`Error: ${xhr.status}`);
            $(`#${collapseId} .accordion-body`)
              .html(`<div class="text-danger">Request failed: ${url}</div>`);
          }
        });      });
    }

    $(document).ready(function() {
      $('#populate-projects').on('click', populateProjects);
    });
  </script>