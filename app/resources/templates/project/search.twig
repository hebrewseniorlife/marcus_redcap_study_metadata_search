<!-- Search Form -->
<div class="row">
    <div class="col-md-10">
        <form action="{{paths.module | raw}}" accept-charset="UTF-8" method="get">
            <input type="hidden" name="prefix" value="{{ module.prefix }}"/>
            <input type="hidden" name="pid" value="{{ module.pid }}"/>
            <input type="hidden" name="page" value="index"/>
            <input type="hidden" name="action" value="search"/>

            <div class="input-group">
                <input type="text" class="form-control" id="search" name="search" value="{{ search }}" placeholder="form or field name...">
                <span class="input-group-btn ml-3">
                    <button type="submit" class="btn btn-primary">Search</button>

                    <div class="btn-group" role="group">
                        <button id="cartButtonGroup" type="button" 
                            class="btn btn-secondary dropdown-toggle" data-toggle="dropdown"><span id="cart-button-text">Cart ({{ cart.documents | length }})</span></button>
                        <div class="dropdown-menu" aria-labelledby="cartButtonGroup">
                            <a class="dropdown-item" href="{{ paths.api | raw }}&entity=cart&action=export" target="_new" id="export-cart-link"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>&nbsp; Data Dictionary (only)</a>
                            <a class="dropdown-item" href="{{ paths.api | raw }}&entity=cart&action=export" target="_new" id="export-cart-csv-link"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>&nbsp; CSV (cart)</a>                            
                            <a class="dropdown-item" href="#" id="view-cart-link"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z"/>
                            </svg>&nbsp; View</a>
                        </div>
                    </div>
                </span>
            </div>
        </form>
    </div>
</div>


{% if results != null %}
<div class="row">
    <div class="col-md-10"><hr/></div>
</div>

<div class="row">
    <div class="col-md-10">
        <form id="documents-form" action="{{paths.api | raw}}" accept-charset="UTF-8" method="post">
            <input type="hidden" name="action" value=""/>
            <input type="hidden" name="entity" value="cart"/>
            <div class="row">
                <div class="col-md-12">   
                    <table class="table table-striped table-bordered" style="width:100%;" id="results">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Project</th>
                                <th scope="col">Name</th>
                                <th scope="col">Form</th>
                                <th scope="col">Entity</th>
                                <th scope="col">Label</th>
                                <th scope="col">Data Type</th>
                                <th scope="col">Choices/Calculation</th>
                            </tr>
                        </thead>     
                        <tbody>
                            
                    {% for id, document in results.documents %}
                            <tr>
                                <td scope="row">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="document[]" id="{{ document.id }}" value="{{ document.id }}">
                                    </div>                    
                                </td>
                                <td>{{ document.project_title }} ({{ document.project_id }})</td>
                                <td>{{ document.name }}</td>
                                <td>{{ document.context.form_name }}</td>
                                <td>{{ document.entity }}</td>
                                <td>{{ document.label }}</td>
                                <td>{{ document.field_type }}</td>       
                                <td>{{ document.context.select_choices_or_calculations | split("|") | join('</br>') | raw }}</td> 
                                {# <td style="display:none">{{ document.context | json_encode() }}</td>  #}
                            </tr>     
                    {% else %}
                            <tr>
                                <td colspan="7">
                                    <div class="bs-callout bs-callout-primary" style="background: white">
                                        No results found.
                                    </div>
                                </td>
                            </tr>
                    {% endfor %}
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    $('#documents-form').submit(onDocumentsFormSubmit);

    var options = {
        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ]
        , "pageLength": 50
        , "oLanguage": {
            "sSearch": "Filter"
        }
        , "dom": 'Bfltip'
        , "buttons": [
            {
                text: 'Check All',
                action: function ( e, dt, node, config ) {
                    $('#documents-form input:checkbox').prop('checked', true);
                }
            },
            {
                text: 'Uncheck All',
                action: function ( e, dt, node, config ) {
                    $('#documents-form input:checkbox').prop('checked', false);
                }
            },     
            {
                text: 'Add to Cart',
                action: function ( e, dt, node, config ) {
                    var action = $('#documents-form > [name="action"]');
                    action.val('add');

                    $('#documents-form').submit();
                }
            }       
        ]
    };

    var table = $('#results').DataTable(options);
} );

function onDocumentsFormSubmit(e) {
    e.preventDefault(); // avoid to execute the actual submit of the form.

    var form = $(this);
    var url = form.attr('action');

    $.ajax({
           type: "POST",
           url: url,
           data: form.serialize(),
           success: function(data, status)
           {
               console.log(data);

               if (data.message != ""){
                   $("#modal-dialog-message").text(data.message);
                   $("#modal-dialog-title").text("Study Metadata Cart");
                   $('#modal-dialog').modal('show');

                   $('#cart-button-text').text('Cart (' + data.count + ')');
               }
           }
    }); 
}
</script>

{% endif %}
